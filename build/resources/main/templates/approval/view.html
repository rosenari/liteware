<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title th:text="${document.title} + ' | Liteware'">문서 상세 | Liteware</title>
    <style>
        .approval-status-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-approved { background-color: #28a745; color: #fff; }
        .status-rejected { background-color: #dc3545; color: #fff; }
        .approval-line-item { border: 1px solid #dee2e6; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .approval-line-item.completed { background-color: #d4edda; }
        .approval-line-item.current { background-color: #fff3cd; }
        .approval-line-item.pending { background-color: #f8f9fa; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div th:replace="~{layout/base :: content-header(pageTitle='전자결재 상세')"></div>
    
    <div class="row">
        <!-- 좌측: 문서 내용 -->
        <div class="col-md-8">
            <!-- 문서 헤더 -->
            <div class="card">
                <div class="card-header bg-primary">
                    <h3 class="card-title">
                        <i class="fas fa-file-alt"></i> 
                        <span th:text="${document?.title}">연차 휴가 신청의 건</span>
                    </h3>
                    <div class="card-tools">
                        <span class="approval-status-badge"
                              th:classappend="${document?.status?.name() == 'APPROVED' ? 'status-approved' : 
                                             (document?.status?.name() == 'REJECTED' ? 'status-rejected' : 'status-pending')}"
                              th:text="${document?.status?.description}">결재중</span>
                    </div>
                </div>
                
                <!-- 문서 정보 테이블 -->
                <div class="card-body">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th style="width: 150px; background-color: #f8f9fa;">문서번호</th>
                                <td th:text="${document?.docNumber}">DOC-2025-001</td>
                                <th style="width: 150px; background-color: #f8f9fa;">문서유형</th>
                                <td>
                                    <span class="badge badge-info" th:text="${document?.docType?.description}">휴가신청</span>
                                </td>
                            </tr>
                            <tr>
                                <th style="background-color: #f8f9fa;">기안자</th>
                                <td th:text="${document?.drafter?.name}">홍길동</td>
                                <th style="background-color: #f8f9fa;">기안부서</th>
                                <td th:text="${document?.drafter?.department?.name}">개발팀</td>
                            </tr>
                            <tr>
                                <th style="background-color: #f8f9fa;">기안일</th>
                                <td th:text="${#temporals.format(document?.draftedAt, 'yyyy.MM.dd HH:mm')}">2025.01.05 14:30</td>
                                <th style="background-color: #f8f9fa;">긴급도</th>
                                <td>
                                    <span class="badge"
                                          th:classappend="${document?.urgency?.name() == 'VERY_URGENT' ? 'badge-danger' : 
                                                          (document?.urgency?.name() == 'URGENT' ? 'badge-warning' : 'badge-secondary')}"
                                          th:text="${document?.urgency?.description}">보통</span>
                                </td>
                            </tr>
                            
                            <!-- 휴가신청서인 경우 추가 정보 -->
                            <tr th:if="${document?.docType?.name() == 'VACATION'}">
                                <th style="background-color: #f8f9fa;">휴가기간</th>
                                <td colspan="3">
                                    2025.01.10 ~ 2025.01.12 (3일간)
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- 문서 내용 -->
                    <div class="mt-4">
                        <h5>상세 내용</h5>
                        <div class="border p-3" style="min-height: 300px; background-color: #fff;">
                            <div th:utext="${document?.content}">
                                <p>개인 사유로 인한 연차 휴가를 신청합니다.</p>
                                <ul>
                                    <li>휴가 기간: 2025년 1월 10일 ~ 2025년 1월 12일 (3일간)</li>
                                    <li>휴가 사유: 개인 사유</li>
                                    <li>비상연락처: 010-1234-5678</li>
                                    <li>업무 인수인계: 김대리</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 첨부파일 -->
                    <div class="mt-4" th:if="${document?.attachments != null and !document.attachments.isEmpty()}">
                        <h5>첨부파일</h5>
                        <div class="list-group">
                            <a href="#" class="list-group-item list-group-item-action" 
                               th:each="file : ${document.attachments}">
                                <i class="fas fa-paperclip"></i> 
                                <span th:text="${file.fileName}">증빙서류.pdf</span>
                                <span class="badge badge-secondary float-right" th:text="${file.fileSize}">1.2MB</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- 결재 의견 -->
                    <div class="mt-4">
                        <h5>결재 의견</h5>
                        <div class="timeline">
                            <div th:each="line : ${document?.approvalLines}" th:if="${line.status?.name() != 'PENDING'}">
                                <i class="fas" th:classappend="${line.status?.name() == 'APPROVED' ? 'fa-check bg-success' : 'fa-times bg-danger'}"></i>
                                <div class="timeline-item">
                                    <span class="time">
                                        <i class="fas fa-clock"></i>
                                        <span th:text="${#temporals.format(line.processedAt, 'MM.dd HH:mm')}">01.05 15:30</span>
                                    </span>
                                    <h3 class="timeline-header">
                                        <span th:text="${line.approver?.name}">김부장</span>
                                        <span class="badge" 
                                              th:classappend="${line.status?.name() == 'APPROVED' ? 'badge-success' : 'badge-danger'}"
                                              th:text="${line.status?.description}">승인</span>
                                    </h3>
                                    <div class="timeline-body" th:if="${line.comment != null and !line.comment.isEmpty()}">
                                        <p th:text="${line.comment}">승인합니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 결재 액션 (현재 결재자인 경우) -->
            <div class="card" th:if="${isCurrentApprover}">
                <div class="card-header bg-warning">
                    <h3 class="card-title">
                        <i class="fas fa-signature"></i> 결재 처리
                    </h3>
                </div>
                <div class="card-body">
                    <form id="approvalForm" method="post">
                        <div class="form-group">
                            <label>결재 의견</label>
                            <textarea class="form-control" name="comment" rows="3" 
                                      placeholder="결재 의견을 입력하세요 (선택사항)"></textarea>
                        </div>
                        <div class="text-center">
                            <button type="button" class="btn btn-success btn-lg" onclick="processApproval('APPROVED')">
                                <i class="fas fa-check"></i> 승인
                            </button>
                            <button type="button" class="btn btn-danger btn-lg" onclick="processApproval('REJECTED')">
                                <i class="fas fa-times"></i> 반려
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg" onclick="history.back()">
                                <i class="fas fa-arrow-left"></i> 보류
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 우측: 결재선 및 문서 정보 -->
        <div class="col-md-4">
            <!-- 결재선 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-route"></i> 결재선
                    </h3>
                </div>
                <div class="card-body">
                    <div th:each="line, stat : ${document?.approvalLines}" 
                         class="approval-line-item"
                         th:classappend="${line.status?.name() == 'APPROVED' ? 'completed' : 
                                         (line.status?.name() == 'PENDING' and stat.index == currentApprovalIndex ? 'current' : 
                                         (line.status?.name() == 'PENDING' ? 'pending' : ''))}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong th:text="${line.approver?.name}">김부장</strong>
                                <br>
                                <small class="text-muted" th:text="${line.approver?.position?.name}">부장</small>
                            </div>
                            <div class="text-right">
                                <span class="badge"
                                      th:classappend="${line.status?.name() == 'APPROVED' ? 'badge-success' : 
                                                      (line.status?.name() == 'REJECTED' ? 'badge-danger' : 
                                                      (line.status?.name() == 'PENDING' ? 'badge-warning' : 'badge-secondary'))}"
                                      th:text="${line.status?.description}">대기</span>
                                <br>
                                <small th:if="${line.processedAt != null}" 
                                       th:text="${#temporals.format(line.processedAt, 'MM.dd HH:mm')}">01.05 15:30</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 참조자 -->
            <div class="card" th:if="${document?.references != null and !document.references.isEmpty()}">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-eye"></i> 참조자
                    </h3>
                </div>
                <div class="card-body">
                    <div th:each="ref : ${document.references}">
                        <span class="badge badge-secondary" th:text="${ref.name}">이과장</span>
                    </div>
                </div>
            </div>
            
            <!-- 문서 이력 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i> 문서 이력
                    </h3>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <small class="text-muted">2025.01.05 14:30</small><br>
                            문서 기안 - 홍길동
                        </li>
                        <li class="list-group-item" th:each="history : ${document?.histories}">
                            <small class="text-muted" th:text="${#temporals.format(history.createdAt, 'yyyy.MM.dd HH:mm')}">2025.01.05 15:30</small><br>
                            <span th:text="${history.action}">김부장 승인</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- 액션 버튼 -->
            <div class="card">
                <div class="card-body">
                    <button class="btn btn-primary btn-block" onclick="printDocument()">
                        <i class="fas fa-print"></i> 인쇄
                    </button>
                    <button class="btn btn-info btn-block" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf"></i> PDF 다운로드
                    </button>
                    <a th:href="@{/approval}" class="btn btn-secondary btn-block">
                        <i class="fas fa-list"></i> 목록으로
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
<script>
function processApproval(status) {
    if (status === 'REJECTED') {
        if (!confirm('정말 반려하시겠습니까?')) {
            return;
        }
    } else if (status === 'APPROVED') {
        if (!confirm('승인하시겠습니까?')) {
            return;
        }
    }
    
    var form = document.getElementById('approvalForm');
    var formData = new FormData(form);
    formData.append('status', status);
    
    fetch('/approval/process/' + [[${document?.docId}]], {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('결재 처리가 완료되었습니다.');
            location.reload();
        } else {
            alert('결재 처리 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        alert('결재 처리 중 오류가 발생했습니다.');
    });
}

function printDocument() {
    window.print();
}

function downloadPDF() {
    window.location.href = '/approval/download/' + [[${document?.docId}]];
}
</script>
</th:block>
</body>
</html>