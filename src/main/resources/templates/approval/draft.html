<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>기안 작성 | Liteware</title>
    <!-- Summernote CSS -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
    <!-- Select2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
    <style>
        .user-item { padding: 8px; border-bottom: 1px solid #dee2e6; }
        .user-item:hover { background-color: #f8f9fa; cursor: pointer; }
        .dept-item { cursor: pointer; padding: 5px; border-radius: 3px; }
        .dept-item:hover { background-color: #e9ecef; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">기안 작성</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/">홈</a></li>
                        <li class="breadcrumb-item">전자결재</li>
                        <li class="breadcrumb-item active">기안 작성</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
    
    <form id="draftForm" method="post" th:action="${isEdit} ? @{/approval/draft(id=${document?.docId})} : @{/approval/draft}" enctype="multipart/form-data">
        <!-- 수정 모드일 때 문서 ID 전달 -->
        <input th:if="${isEdit}" type="hidden" name="docId" th:value="${document?.docId}" />
        <div class="row">
            <!-- 좌측 영역: 문서 작성 -->
            <div class="col-md-8">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-edit"></i> 문서 작성
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- 문서 유형 선택 -->
                        <div class="form-group">
                            <label>문서 유형 <span class="text-danger">*</span></label>
                            <select class="form-control select2" id="docType" name="docType" required>
                                <option value="">선택하세요</option>
                                <option value="LEAVE_REQUEST" th:selected="${document?.docType?.name() == 'LEAVE_REQUEST'}">휴가 신청</option>
                                <option value="OVERTIME_REQUEST" th:selected="${document?.docType?.name() == 'OVERTIME_REQUEST'}">연장근무 신청</option>
                                <option value="EXPENSE_REQUEST" th:selected="${document?.docType?.name() == 'EXPENSE_REQUEST'}">경비 청구</option>
                                <option value="PURCHASE_REQUEST" th:selected="${document?.docType?.name() == 'PURCHASE_REQUEST'}">구매 요청</option>
                                <option value="GENERAL_APPROVAL" th:selected="${document?.docType?.name() == 'GENERAL_APPROVAL'}">일반 결재</option>
                                <option value="BUSINESS_TRIP" th:selected="${document?.docType?.name() == 'BUSINESS_TRIP'}">출장 신청</option>
                                <option value="WORK_FROM_HOME" th:selected="${document?.docType?.name() == 'WORK_FROM_HOME'}">재택근무 신청</option>
                                <option value="RESIGNATION" th:selected="${document?.docType?.name() == 'RESIGNATION'}">퇴직 신청</option>
                            </select>
                        </div>
                        
                        <!-- 휴가 신청 양식 -->
                        <div id="vacationForm" class="doc-form" style="display:none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>휴가 종류</label>
                                        <select class="form-control" name="vacationType">
                                            <option value="ANNUAL">연차</option>
                                            <option value="SICK">병가</option>
                                            <option value="SPECIAL">경조사</option>
                                            <option value="OTHER">기타</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>긴급도</label>
                                        <select class="form-control" name="urgency">
                                            <option value="NORMAL">보통</option>
                                            <option value="URGENT">긴급</option>
                                            <option value="VERY_URGENT">매우긴급</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>시작일</label>
                                        <input type="date" class="form-control" name="startDate">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>시작시간</label>
                                        <input type="time" class="form-control" name="startTime" value="09:00">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>종료일</label>
                                        <input type="date" class="form-control" name="endDate">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>종료시간</label>
                                        <input type="time" class="form-control" name="endTime" value="18:00">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="isHourlyLeave" name="isHourlyLeave"> 
                                            시간단위 휴가
                                        </label>
                                        <small class="form-text text-muted">
                                            체크하면 시간 단위로 휴가를 신청할 수 있습니다.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 경비 청구 양식 -->
                        <div id="expenseForm" class="doc-form" style="display:none;">
                            <div class="form-group">
                                <label>청구 금액</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="amount" placeholder="0">
                                    <div class="input-group-append">
                                        <span class="input-group-text">원</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>사용 일자</label>
                                <input type="date" class="form-control" name="expenseDate">
                            </div>
                            <div class="form-group">
                                <label>사용 내역</label>
                                <textarea class="form-control" name="expenseDetail" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <!-- 공통 필드 -->
                        <div class="form-group">
                            <label>제목 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   placeholder="문서 제목을 입력하세요"
                                   th:value="${document?.title}">
                        </div>
                        
                        <div class="form-group">
                            <label>내용 <span class="text-danger">*</span></label>
                            <textarea id="summernote" name="content" required th:text="${document?.content}"></textarea>
                        </div>
                        
                        <!-- 첨부파일 -->
                        <div class="form-group">
                            <label>첨부파일</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="attachmentFiles" multiple>
                                <label class="custom-file-label" for="attachments">파일을 선택하세요</label>
                            </div>
                            <small class="form-text text-muted">
                                최대 10MB, 여러 파일 선택 가능
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 우측 영역: 결재선 -->
            <div class="col-md-4">
                <!-- 결재선 설정 -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-route"></i> 결재선
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool btn-sm" data-toggle="modal" data-target="#approverModal">
                                <i class="fas fa-plus"></i> 결재자 추가
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm" id="approvalLineTable">
                            <thead>
                                <tr>
                                    <th style="width: 60px">순서</th>
                                    <th>결재자</th>
                                    <th style="width: 80px">구분</th>
                                    <th style="width: 40px"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="no-approver">
                                    <td colspan="4" class="text-center text-muted py-3">
                                        결재자를 추가하세요
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 참조자 설정 -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-eye"></i> 참조자
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool btn-sm" data-toggle="modal" data-target="#referenceModal">
                                <i class="fas fa-plus"></i> 참조자 추가
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="referenceList">
                            <p class="text-muted text-center">참조자 없음</p>
                        </div>
                    </div>
                </div>
                
                <!-- 문서 정보 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-info-circle"></i> 문서 정보
                        </h3>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">기안자</dt>
                            <dd class="col-sm-7" th:text="${#authentication.name}">홍길동</dd>
                            <dt class="col-sm-5">기안부서</dt>
                            <dd class="col-sm-7">개발팀</dd>
                            <dt class="col-sm-5">기안일</dt>
                            <dd class="col-sm-7" th:text="${#temporals.format(#temporals.createNow(), 'yyyy.MM.dd')}"></dd>
                            <dt class="col-sm-5">보존연한</dt>
                            <dd class="col-sm-7">
                                <select class="form-control form-control-sm" name="preservationYears">
                                    <option value="1">1년</option>
                                    <option value="3" selected>3년</option>
                                    <option value="5">5년</option>
                                    <option value="10">10년</option>
                                    <option value="0">영구</option>
                                </select>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 하단 버튼 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="button" class="btn btn-primary" onclick="saveDraft()">
                            <i class="fas fa-save"></i> 기안 저장
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="previewDocument()">
                            <i class="fas fa-eye"></i> 미리보기
                        </button>
                        <a href="/approval" class="btn btn-danger">
                            <i class="fas fa-times"></i> 취소
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    <!-- 결재자 선택 모달 -->
<div class="modal fade" id="approverModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">결재자 선택</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>조직도</h6>
                        <div id="orgTree" style="max-height: 400px; overflow-y: auto;">
                            <!-- 조직도 트리 (JavaScript로 생성) -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>사용자 목록</h6>
                        <input type="text" id="userSearch" class="form-control form-control-sm mb-2" 
                               placeholder="이름으로 검색">
                        <div id="userList" style="max-height: 400px; overflow-y: auto;">
                            <!-- 사용자 목록 (JavaScript로 생성) -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedApprover()">추가</button>
            </div>
        </div>
    </div>
</div>

<!-- 참조자 선택 모달 -->
<div class="modal fade" id="referenceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">참조자 선택</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5>부서별 조직도</h5>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <div id="referenceDepartmentTree"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5>사용자 목록</h5>
                                <div class="float-right">
                                    <input type="text" id="referenceUserSearch" class="form-control form-control-sm" 
                                           placeholder="이름으로 검색" style="width: 200px; display: inline-block;">
                                </div>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm" id="referenceUserTable">
                                    <thead>
                                        <tr>
                                            <th>이름</th>
                                            <th>부서</th>
                                            <th>직급</th>
                                            <th>선택</th>
                                        </tr>
                                    </thead>
                                    <tbody id="referenceUserTableBody">
                                        <!-- 사용자 목록이 여기에 로드됩니다 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>

        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
<!-- Summernote JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-ko-KR.js"></script>
<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Summernote 초기화
    $('#summernote').summernote({
        height: 400,
        lang: 'ko-KR',
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'underline', 'clear']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link', 'picture']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ]
    });
    
    // Select2 초기화
    $('.select2').select2({
        theme: 'bootstrap4'
    });
    
    // 문서 유형 변경시 양식 변경
    $('#docType').change(function() {
        $('.doc-form').hide();
        
        switch($(this).val()) {
            case 'LEAVE_REQUEST':
                $('#vacationForm').show();
                break;
            case 'EXPENSE_REQUEST':
                $('#expenseForm').show();
                break;
        }
    });
    
    // 파일 선택시 라벨 변경 및 name 속성 추가
    $('.custom-file-input').on('change', function() {
        var files = $(this)[0].files;
        if (files.length > 0) {
            var label = files.length > 1 ? files.length + '개 파일 선택됨' : files[0].name;
            $(this).next('.custom-file-label').text(label);
            // 파일이 선택되면 name 속성 추가
            $(this).attr('name', 'attachments');
        } else {
            $(this).next('.custom-file-label').text('파일을 선택하세요');
            // 파일이 없으면 name 속성 제거
            $(this).removeAttr('name');
        }
    });
    
    // 시간 단위 휴가 체크박스 이벤트
    $('#isHourlyLeave').change(function() {
        const isHourly = $(this).is(':checked');
        const startTimeInput = $('input[name="startTime"]');
        const endTimeInput = $('input[name="endTime"]');
        
        if (isHourly) {
            // 시간단위 휴가: 시간 선택 가능
            startTimeInput.prop('disabled', false).prop('readonly', false);
            endTimeInput.prop('disabled', false).prop('readonly', false);
            // 같은 날짜로 설정
            const startDate = $('input[name="startDate"]').val();
            if (startDate) {
                $('input[name="endDate"]').val(startDate);
            }
        } else {
            // 일단위 휴가: 9시-18시 고정 (8시간)
            startTimeInput.val('09:00').prop('disabled', true).prop('readonly', true);
            endTimeInput.val('18:00').prop('disabled', true).prop('readonly', true);
        }
    });
    
    // 페이지 로드시 일단위 휴가로 초기화
    $('#isHourlyLeave').prop('checked', false).trigger('change');
    
    // 폼 제출 전 첨부파일 처리
    $('form').on('submit', function(e) {
        // 파일이 선택되지 않았다면 name 속성 제거
        var fileInput = $('#attachmentFiles');
        if (fileInput[0].files.length === 0) {
            fileInput.removeAttr('name');
        }
        
        // Summernote 내용을 textarea에 동기화
        var content = $('.note-editable').html();
        $('textarea[name="content"]').val(content);
    });
    
    // 결재자 모달이 열릴 때 조직도 데이터 로드
    $('#approverModal').on('show.bs.modal', function() {
        loadOrganizationData();
    });
    
    // 참조자 모달이 열릴 때 조직도 데이터 로드
    $('#referenceModal').on('show.bs.modal', function() {
        loadReferenceData();
    });
    
    // 사용자 검색 이벤트
    $('#userSearch').on('keyup', function() {
        const keyword = $(this).val().trim();
        searchUsers(keyword);
    });
    
    $('#referenceUserSearch').on('keyup', function() {
        const keyword = $(this).val().trim();
        searchReferenceUsers(keyword);
    });
});

// 전역 변수
let approverSequence = 1;
let selectedReferences = [];

// 조직도 데이터 로드
function loadOrganizationData() {
    // 부서 목록 로드
    $.ajax({
        url: '/api/organization/departments',
        method: 'GET',
        success: function(departments) {
            renderOrgTree(departments);
        },
        error: function() {
            console.error('Failed to load departments');
            $('#orgTree').html('<p class="text-muted">부서 정보를 불러올 수 없습니다.</p>');
        }
    });
    
    // 사용자 목록 로드
    $.ajax({
        url: '/api/users',
        method: 'GET',
        success: function(users) {
            renderUserList(users);
        },
        error: function() {
            console.error('Failed to load users');
            $('#userList').html('<p class="text-muted">사용자 정보를 불러올 수 없습니다.</p>');
        }
    });
}

// 조직도 트리 렌더링
function renderOrgTree(departments) {
    if (!departments || departments.length === 0) {
        $('#orgTree').html('<p class="text-muted">부서 정보가 없습니다.</p>');
        return;
    }
    
    let treeHtml = '<ul class="list-unstyled">';
    
    // 상위 부서만 먼저 표시
    const rootDepartments = departments.filter(dept => !dept.parentDepartment);
    
    rootDepartments.forEach(dept => {
        treeHtml += `<li class="mb-2">
            <i class="fas fa-folder text-primary"></i>
            <a href="#" onclick="loadDepartmentUsers(${dept.deptId})" class="ml-1">
                ${dept.deptName}
            </a>
        </li>`;
        
        // 하위 부서 표시
        const subDepts = departments.filter(d => d.parentDepartment && d.parentDepartment.deptId === dept.deptId);
        if (subDepts.length > 0) {
            treeHtml += '<ul class="list-unstyled ml-3">';
            subDepts.forEach(subDept => {
                treeHtml += `<li class="mb-1">
                    <i class="fas fa-folder-open text-info"></i>
                    <a href="#" onclick="loadDepartmentUsers(${subDept.deptId})" class="ml-1">
                        ${subDept.deptName}
                    </a>
                </li>`;
            });
            treeHtml += '</ul>';
        }
    });
    
    treeHtml += '</ul>';
    $('#orgTree').html(treeHtml);
}

// 사용자 목록 렌더링
function renderUserList(users) {
    if (!users || users.length === 0) {
        $('#userList').html('<p class="text-muted">사용자가 없습니다.</p>');
        return;
    }
    
    let listHtml = '';
    users.forEach(user => {
        const deptName = user.department ? user.department.deptName : '미지정';
        const positionName = user.position ? user.position.positionName : '미지정';
        
        listHtml += `
            <div class="user-item" style="cursor: pointer;" 
                 onclick="selectApprover(${user.userId}, '${user.name}', '${positionName}', '${deptName}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${user.name}</strong>
                        <small class="text-muted">(${positionName})</small>
                        <br>
                        <small class="text-muted">${deptName}</small>
                    </div>
                    <input type="radio" name="approverRadio" value="${user.userId}">
                </div>
            </div>`;
    });
    
    $('#userList').html(listHtml);
}

// 부서별 사용자 로드
function loadDepartmentUsers(deptId) {
    $.ajax({
        url: `/api/organization/departments/${deptId}/users`,
        method: 'GET',
        success: function(users) {
            renderUserList(users);
        },
        error: function() {
            console.error('Failed to load department users');
            $('#userList').html('<p class="text-muted">사용자 정보를 불러올 수 없습니다.</p>');
        }
    });
}

// 사용자 검색
function searchUsers(keyword) {
    if (!keyword || keyword.trim() === '') {
        // 전체 사용자 목록 로드
        $.ajax({
            url: '/api/users',
            method: 'GET',
            success: function(users) {
                renderUserList(users);
            },
            error: function() {
                $('#userList').html('<p class="text-muted">사용자 정보를 불러올 수 없습니다.</p>');
            }
        });
        return;
    }
    
    $.ajax({
        url: '/api/organization/users/search',
        method: 'GET',
        data: { keyword: keyword },
        success: function(users) {
            renderUserList(users);
        },
        error: function() {
            console.error('Failed to search users');
            $('#userList').html('<p class="text-muted">검색 결과가 없습니다.</p>');
        }
    });
}

// 참조자 검색
function searchReferenceUsers(keyword) {
    if (!keyword || keyword.trim() === '') {
        loadReferenceUsers();
        return;
    }
    
    $.ajax({
        url: '/api/organization/users/search',
        method: 'GET',
        data: { keyword: keyword },
        success: function(users) {
            renderReferenceUserTable(users);
        },
        error: function() {
            $('#referenceUserTableBody').html('<tr><td colspan="4" class="text-center">검색 결과가 없습니다.</td></tr>');
        }
    });
}

// 참조자 모달 데이터 로드
function loadReferenceData() {
    // 부서 목록 로드
    $.ajax({
        url: '/api/organization/departments',
        method: 'GET',
        success: function(departments) {
            renderReferenceDepartmentTree(departments);
        },
        error: function() {
            $('#referenceDepartmentTree').html('<p class="text-muted">부서 정보를 불러올 수 없습니다.</p>');
        }
    });
    
    // 사용자 목록 로드
    loadReferenceUsers();
}

// 참조자 사용자 목록 로드
function loadReferenceUsers() {
    $.ajax({
        url: '/api/users',
        method: 'GET',
        success: function(users) {
            renderReferenceUserTable(users);
        },
        error: function() {
            $('#referenceUserTableBody').html('<tr><td colspan="4" class="text-center">사용자 정보를 불러올 수 없습니다.</td></tr>');
        }
    });
}

// 참조자 부서 트리 렌더링
function renderReferenceDepartmentTree(departments) {
    if (!departments || departments.length === 0) {
        $('#referenceDepartmentTree').html('<p class="text-muted">부서 정보가 없습니다.</p>');
        return;
    }
    
    let treeHtml = '<ul class="list-unstyled">';
    const rootDepartments = departments.filter(dept => !dept.parentDepartment);
    
    rootDepartments.forEach(dept => {
        treeHtml += `<li class="mb-2">
            <i class="fas fa-folder text-primary"></i>
            <a href="#" onclick="loadReferenceDepartmentUsers(${dept.deptId})" class="ml-1">
                ${dept.deptName}
            </a>
        </li>`;
        
        const subDepts = departments.filter(d => d.parentDepartment && d.parentDepartment.deptId === dept.deptId);
        if (subDepts.length > 0) {
            treeHtml += '<ul class="list-unstyled ml-3">';
            subDepts.forEach(subDept => {
                treeHtml += `<li class="mb-1">
                    <i class="fas fa-folder-open text-info"></i>
                    <a href="#" onclick="loadReferenceDepartmentUsers(${subDept.deptId})" class="ml-1">
                        ${subDept.deptName}
                    </a>
                </li>`;
            });
            treeHtml += '</ul>';
        }
    });
    
    treeHtml += '</ul>';
    $('#referenceDepartmentTree').html(treeHtml);
}

// 참조자 부서별 사용자 로드
function loadReferenceDepartmentUsers(deptId) {
    $.ajax({
        url: `/api/organization/departments/${deptId}/users`,
        method: 'GET',
        success: function(users) {
            renderReferenceUserTable(users);
        },
        error: function() {
            $('#referenceUserTableBody').html('<tr><td colspan="4" class="text-center">사용자 정보를 불러올 수 없습니다.</td></tr>');
        }
    });
}

// 참조자 사용자 테이블 렌더링
function renderReferenceUserTable(users) {
    if (!users || users.length === 0) {
        $('#referenceUserTableBody').html('<tr><td colspan="4" class="text-center">사용자가 없습니다.</td></tr>');
        return;
    }
    
    let tableHtml = '';
    users.forEach(user => {
        const deptName = user.department ? user.department.deptName : '미지정';
        const positionName = user.position ? user.position.positionName : '미지정';
        
        tableHtml += `
            <tr>
                <td>${user.name}</td>
                <td>${deptName}</td>
                <td>${positionName}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" 
                            onclick="addReferenceToList({userId: ${user.userId}, name: '${user.name}', department: '${deptName}', position: '${positionName}'})">
                        <i class="fas fa-plus"></i> 추가
                    </button>
                </td>
            </tr>`;
    });
    
    $('#referenceUserTableBody').html(tableHtml);
}

// 참조자 목록에 추가
function addReferenceToList(user) {
    // 이미 추가된 참조자인지 확인
    if (selectedReferences.some(ref => ref.userId === user.userId)) {
        alert('이미 추가된 참조자입니다.');
        return;
    }
    
    selectedReferences.push(user);
    
    // 참조자 목록 UI 업데이트
    let refHtml = '';
    selectedReferences.forEach(ref => {
        refHtml += `
            <div class="badge badge-info m-1" data-user-id="${ref.userId}">
                ${ref.name} (${ref.department})
                <span class="ml-1" style="cursor: pointer;" onclick="removeReference(${ref.userId})">
                    <i class="fas fa-times"></i>
                </span>
                <input type="hidden" name="referenceIds" value="${ref.userId}">
            </div>
        `;
    });
    
    if (selectedReferences.length === 0) {
        refHtml = '<p class="text-muted text-center">참조자 없음</p>';
    }
    
    $('#referenceList').html(refHtml);
    $('#referenceModal').modal('hide');
}

// 참조자 제거
function removeReference(userId) {
    selectedReferences = selectedReferences.filter(ref => ref.userId !== userId);
    
    let refHtml = '';
    selectedReferences.forEach(ref => {
        refHtml += `
            <div class="badge badge-info m-1" data-user-id="${ref.userId}">
                ${ref.name} (${ref.department})
                <span class="ml-1" style="cursor: pointer;" onclick="removeReference(${ref.userId})">
                    <i class="fas fa-times"></i>
                </span>
                <input type="hidden" name="referenceIds" value="${ref.userId}">
            </div>
        `;
    });
    
    if (selectedReferences.length === 0) {
        refHtml = '<p class="text-muted text-center">참조자 없음</p>';
    }
    
    $('#referenceList').html(refHtml);
}

// 선택된 결재자
let selectedApprover = null;

// 결재자 선택
function selectApprover(userId, name, position, department) {
    selectedApprover = {
        userId: userId,
        name: name,
        position: position,
        department: department
    };
    // 라디오 버튼 체크
    $(`input[name="approverRadio"][value="${userId}"]`).prop('checked', true);
}

// 선택된 결재자 추가
function addSelectedApprover() {
    if (!selectedApprover) {
        alert('결재자를 선택해주세요.');
        return;
    }
    
    // 이미 추가된 결재자인지 확인
    if ($(`#approvalLineTable tr[data-user-id="${selectedApprover.userId}"]`).length > 0) {
        alert('이미 추가된 결재자입니다.');
        return;
    }
    
    // "결재자를 추가하세요" 행 제거
    $('.no-approver').remove();
    
    const rowHtml = `<tr data-user-id="${selectedApprover.userId}" data-sequence="${approverSequence}">
        <td class="text-center">${approverSequence}</td>
        <td>
            <strong>${selectedApprover.name}</strong><br>
            <small class="text-muted">${selectedApprover.department} / ${selectedApprover.position}</small>
        </td>
        <td>
            <span class="badge badge-primary">결재</span>
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeApprover(this)">
                <i class="fas fa-times"></i>
            </button>
        </td>
        <input type="hidden" name="approverIds" value="${selectedApprover.userId}">
    </tr>`;
    
    $('#approvalLineTable tbody').append(rowHtml);
    approverSequence++;
    selectedApprover = null;
    
    // 모달 닫기
    $('#approverModal').modal('hide');
}

// 결재자 제거
function removeApprover(button) {
    $(button).closest('tr').remove();
    
    // 순서 재정렬
    $('#approvalLineTable tbody tr').each(function(index) {
        if (!$(this).hasClass('no-approver')) {
            $(this).find('td:first').text(index + 1);
            $(this).data('sequence', index + 1);
        }
    });
    
    // 결재자가 없으면 안내 메시지 표시
    if ($('#approvalLineTable tbody tr').length === 0) {
        $('#approvalLineTable tbody').append(`
            <tr class="no-approver">
                <td colspan="4" class="text-center text-muted py-3">
                    결재자를 추가하세요
                </td>
            </tr>
        `);
        approverSequence = 1;
    }
}

// 폼 제출 전 검증 및 데이터 정리
$('#draftForm').on('submit', function(e) {
    // 폼 제출은 버튼 클릭 함수에서 처리하므로 여기서는 기본 동작 방지
    e.preventDefault();
    return false;
})

// 기안 저장 - 결재자 없이도 저장 가능
function saveDraft() {
    // 기본 필드 검증
    if (!$('#docType').val()) {
        alert('문서 유형을 선택해주세요.');
        return false;
    }
    if (!$('input[name="title"]').val().trim()) {
        alert('제목을 입력해주세요.');
        return false;
    }
    
    // Summernote 내용 확인
    const content = $('#summernote').summernote('code');
    if (!content || content === '<p><br></p>') {
        alert('내용을 입력해주세요.');
        return false;
    }
    
    const form = $('#draftForm')[0];
    const formData = new FormData(form);
    
    // Summernote 내용 추가
    formData.set('content', content);
    
    // 결재선 데이터 수집 (있는 경우에만)
    $('#approvalLineTable tbody tr:not(.no-approver)').each(function() {
        const userId = $(this).data('user-id');
        if (userId) {
            formData.append('approverIds', userId);
        }
    });
    
    // action 파라미터를 draft로 설정
    formData.append('action', 'draft');
    
    // AJAX로 제출
    $.ajax({
        url: '/approval/draft',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response, status, xhr) {
            // 성공 메시지와 함께 리다이렉트
            alert('문서가 기안 저장되었습니다.');
            // 기안 문서 목록으로 이동
            window.location.href = '/approval?type=drafted';
        },
        error: function(xhr) {
            // 302 리다이렉트는 성공으로 처리
            if (xhr.status === 302 || xhr.status === 0) {
                alert('문서가 기안 저장되었습니다.');
                window.location.href = '/approval?type=drafted';
            } else {
                alert('문서 저장 중 오류가 발생했습니다.');
            }
        }
    });
}

// 상신 기능은 view.html로 이동됨

// 미리보기
function previewDocument() {
    window.open('/approval/preview', 'preview', 'width=800,height=600');
}
</script>

<!-- 수정 모드일 때 기존 데이터 로드 -->
<script th:if="${isEdit}" th:inline="javascript">
$(document).ready(function() {
    // 문서 유형 설정
    var docType = /*[[${document?.docType?.name()}]]*/ '';
    if (docType) {
        $('#docType').val(docType).trigger('change');
    }
    
    // 결재선 로드
    var approvalLines = /*[[${document?.approvalLines}]]*/ [];
    if (approvalLines && approvalLines.length > 0) {
        $('.no-approver').remove();
        let tableHtml = '';
        approvalLines.forEach((line, index) => {
            const approver = line.approver;
            tableHtml += '<tr data-user-id="' + approver.userId + '">';
            tableHtml += '<td>' + (index + 1) + '</td>';
            tableHtml += '<td>' + approver.name + '<br>';
            tableHtml += '<small class="text-muted">' + (approver.department?.deptName || '') + ' / ' + (approver.position?.positionName || '') + '</small>';
            tableHtml += '</td>';
            tableHtml += '<td><span class="badge badge-primary">결재</span></td>';
            tableHtml += '<td>';
            tableHtml += '<button type="button" class="btn btn-sm btn-danger" onclick="removeApprover(this)">';
            tableHtml += '<i class="fas fa-times"></i>';
            tableHtml += '</button>';
            tableHtml += '<input type="hidden" name="approverIds" value="' + approver.userId + '">';
            tableHtml += '</td>';
            tableHtml += '</tr>';
        });
        $('#approvalLineTable tbody').html(tableHtml);
        approverSequence = approvalLines.length + 1;
    }
    
    // 참조자 로드
    var references = /*[[${document?.references}]]*/ [];
    if (references && references.length > 0) {
        selectedReferences = [];
        let refHtml = '';
        references.forEach(ref => {
            const user = ref.user;
            selectedReferences.push(user.userId);
            refHtml += '<span class="badge badge-warning mr-1 mb-1" data-user-id="' + user.userId + '">';
            refHtml += user.name + ' (' + (user.department?.deptName || '') + ')';
            refHtml += '<i class="fas fa-times ml-1" style="cursor:pointer" onclick="removeReference(' + user.userId + ')"></i>';
            refHtml += '<input type="hidden" name="referenceIds" value="' + user.userId + '">';
            refHtml += '</span>';
        });
        $('#referenceList').html(refHtml);
    }
});
</script>
</th:block>

</body>
</html>
